package com.example.mad_gruop_ass

import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.widget.*
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.bumptech.glide.Glide
import kotlinx.coroutines.launch
import java.text.SimpleDateFormat
import java.util.*

class ItemDetailActivity : AppCompatActivity() {
    
    private lateinit var itemImageView: ImageView
    private lateinit var itemNameTextView: TextView
    private lateinit var itemDescriptionTextView: TextView
    private lateinit var itemStatusTextView: TextView
    private lateinit var postedDateTextView: TextView
    private lateinit var distanceTextView: TextView
    private lateinit var likeCountTextView: TextView
    private lateinit var backButton: ImageButton
    private lateinit var lendButton: Button
    private lateinit var ownerProfileButton: LinearLayout
    private lateinit var ownerNameHeader: TextView
    
    private var currentItem: Item? = null
    private var itemId: Int = 0
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_item_detail)
        
        initializeViews()
        setupClickListeners()
        loadItemDetails()
    }
    
    private fun initializeViews() {
        itemImageView = findViewById(R.id.item_image)
        itemNameTextView = findViewById(R.id.item_name)
        itemDescriptionTextView = findViewById(R.id.item_description)
        itemStatusTextView = findViewById(R.id.item_status)
        postedDateTextView = findViewById(R.id.posted_date)
        distanceTextView = findViewById(R.id.distance)
        likeCountTextView = findViewById(R.id.like_count)
        backButton = findViewById(R.id.back_button)
        lendButton = findViewById(R.id.lend_button)
        ownerProfileButton = findViewById(R.id.owner_profile_button)
        ownerNameHeader = findViewById(R.id.owner_name_header)
    }
    
    private fun setupClickListeners() {
        backButton.setOnClickListener { finish() }
        
        lendButton.setOnClickListener { borrowItem() }
        ownerProfileButton.setOnClickListener { 
            Toast.makeText(this, "View User Profile", Toast.LENGTH_SHORT).show()
        }
    }
    
    private fun loadItemDetails() {
        val itemTitle = intent.getStringExtra("itemTitle") ?: ""
        val itemDescription = intent.getStringExtra("itemDescription") ?: ""
        val itemImageUrl = intent.getStringExtra("itemImageUrl") ?: ""
        val itemStatus = intent.getStringExtra("itemStatus") ?: ""
        val itemLikes = intent.getIntExtra("itemLikes", 0)
        val itemDistance = intent.getStringExtra("itemDistance") ?: ""
        val itemCreatedAt = intent.getStringExtra("itemCreatedAt") ?: ""
        val itemUsername = intent.getStringExtra("itemUsername") ?: ""
        itemId = intent.getIntExtra("itemId", 0)
        
        // æ˜¾ç¤ºæ•°æ®
        itemNameTextView.text = itemTitle
        itemDescriptionTextView.text = itemDescription
        itemStatusTextView.text = itemStatus
        postedDateTextView.text = formatDate(itemCreatedAt)
        distanceTextView.text = itemDistance
        likeCountTextView.text = itemLikes.toString()
        ownerNameHeader.text = itemUsername
        
        // åŠ è½½å›¾ç‰‡
        Glide.with(this)
            .load(itemImageUrl)
            .placeholder(R.drawable.default_image)
            .error(R.drawable.default_image)
            .into(itemImageView)
            
        // è®¾ç½®å€Ÿç”¨æŒ‰é’®çŠ¶æ€?        lendButton.isEnabled = itemStatus == "Available"
        if (itemStatus == "Borrowed") {
            lendButton.text = "Borrowed"
        }
    }
    
    private fun borrowItem() {
        lifecycleScope.launch {
            try {
                // ä½¿ç”¨PATCHæ–¹æ³•åªæ›´æ–°ç‰©å“çŠ¶æ€ä¸ºå·²å€Ÿå‡º
                val updatedItem = Item().apply {
                    this.itemId = this@ItemDetailActivity.itemId
                    this.status = "Borrowed" // åªæ›´æ–°çŠ¶æ€ä¸ºå·²å€Ÿå‡º
                }
                
                ApiClient.updateItem(updatedItem, object : ApiClient.ItemCallback {
                    override fun onSuccess(item: Item) {
                        runOnUiThread {
                            // æ›´æ–°UIçŠ¶æ€?                            itemStatusTextView.text = "Borrowed"
                            lendButton.text = "Borrowed"
                            lendButton.isEnabled = false
                            
                            Toast.makeText(this@ItemDetailActivity, 
                                "Borrowed successfully!", 
                                Toast.LENGTH_SHORT).show()
                            
                            // è®¾ç½®ç»“æœï¼Œé€šçŸ¥MainActivityéœ€è¦åˆ·æ–°æ•°æ?                            setResult(RESULT_OK)
                        }
                    }

                    override fun onError(error: String) {
                        runOnUiThread {
                            Toast.makeText(this@ItemDetailActivity, 
                                "Borrow failed: $error", 
                                Toast.LENGTH_SHORT).show()
                        }
                    }
                })
                    
            } catch (e: Exception) {
                Log.e("ItemDetailActivity", "Borrow failed", e)
                Toast.makeText(this@ItemDetailActivity, 
                    "Borrow failed: ${e.message}", 
                    Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun formatDate(inputDateString: String): String {
        if (inputDateString.isEmpty()) return ""
        
        return try {
            // å°è¯•å¤šç§å¯èƒ½çš„æ—¥æœŸæ ¼å¼?            val possibleFormats = listOf(
                "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",  // ISO format with milliseconds
                "yyyy-MM-dd'T'HH:mm:ss'Z'",      // ISO format without milliseconds
                "yyyy-MM-dd HH:mm:ss",           // Standard SQL datetime
                "yyyy-MM-dd"                     // Date only
            )
            
            val outputFormat = SimpleDateFormat("MMM dd, yyyy", Locale.US)
            
            for (format in possibleFormats) {
                try {
                    val inputFormat = SimpleDateFormat(format, Locale.US)
                    val date = inputFormat.parse(inputDateString)
                    return outputFormat.format(date)
                } catch (e: Exception) {
                    continue // Try next format
                }
            }
            
            // If all formats fail, return original string
            inputDateString
        } catch (e: Exception) {
            Log.e("ItemDetailActivity", "Date formatting failed: ${e.message}")
            inputDateString
        }
    }
}
