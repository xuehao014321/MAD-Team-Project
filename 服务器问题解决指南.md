# 🔧 服务器错误问题解决指南

## 🔍 问题诊断

根据你的情况，我发现了以下问题：

### 1. 现状分析
- ✅ Android客户端代码已正确配置，连接到 `http://192.168.0.104:5000/api/`
- ❌ **主要问题**: 当前运行的服务器不是我们创建的完整API服务器
- ⚠️ 现有服务器只返回 "NeighborLink API" 测试响应，缺少注册/登录功能

### 2. 服务器状态检查
```bash
# 测试结果显示
curl http://192.168.0.104:5000/api/test
# 返回: {"message":"✅ NeighborLink API is running!","local_ip":"192.168.0.104","port":5000}

# 但是注册API不可用
POST http://192.168.0.104:5000/api/register
# 预期会失败或返回错误
```

## 🛠️ 解决方案

### 方案1: 启动完整的API服务器（推荐）

#### 步骤1: 停止现有服务器
```bash
# 查找运行在端口5000的进程
netstat -ano | findstr :5000

# 如果找到进程ID，使用以下命令停止
taskkill /PID <进程ID> /F
```

#### 步骤2: 启动我们的完整服务器
```bash
# 在项目根目录运行
node server.js
```

#### 步骤3: 验证服务器功能
```bash
# 测试连接
curl http://192.168.0.104:5000/api/test

# 测试注册功能
curl -X POST http://192.168.0.104:5000/api/register ^
  -H "Content-Type: application/json" ^
  -d "{\"username\":\"testuser\",\"email\":\"test@example.com\",\"password\":\"123456\",\"phone\":\"1234567890\",\"gender\":\"male\"}"
```

### 方案2: 使用不同端口（备选方案）

如果无法停止现有服务器，可以修改我们的服务器端口：

#### 修改服务器端口
```javascript
// 在 server.js 中修改
const PORT = 5001; // 改为5001或其他可用端口
const HOST = '192.168.0.104';
```

#### 相应修改Android客户端
```kotlin
// 在 RetrofitClient.kt 中修改
private const val BASE_URL = "http://192.168.0.104:5001/api/"
```

## 📋 完整启动步骤

### 1. 准备环境
```bash
# 确保在项目根目录
cd "C:\Users\User\Downloads\MAD-Team-Project.hao\MAD-Team-Project.hao"

# 确保依赖已安装
npm install
```

### 2. 启动服务器
```bash
# 启动完整API服务器
npm start
```

### 3. 验证服务器功能
启动后你应该看到以下输出：
```
🚀 服务器启动成功！
📍 服务器地址: http://192.168.0.104:5000
🔗 API基础路径: http://192.168.0.104:5000/api
📝 可用的API端点:
   GET  /api/test          - 测试连接
   POST /api/register      - 用户注册
   POST /api/login         - 用户登录
   GET  /api/users         - 获取所有用户
   GET  /api/users/:id     - 获取特定用户
   GET  /health            - 健康检查
```

## 🧪 测试API功能

### PowerShell测试命令

#### 1. 测试连接
```powershell
Invoke-RestMethod -Uri "http://192.168.0.104:5000/api/test"
```

#### 2. 测试用户注册
```powershell
$body = @{
    username = "testuser"
    email = "test@example.com"
    password = "123456"
    phone = "1234567890"
    gender = "male"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://192.168.0.104:5000/api/register" -Method POST -Body $body -ContentType "application/json"
```

#### 3. 测试用户登录
```powershell
$loginBody = @{
    identifier = "testuser"
    password = "123456"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://192.168.0.104:5000/api/login" -Method POST -Body $loginBody -ContentType "application/json"
```

#### 4. 获取用户列表
```powershell
Invoke-RestMethod -Uri "http://192.168.0.104:5000/api/users"
```

## 🔍 常见错误排查

### 错误1: "Connection refused" 或 "网络错误"
**原因**: 服务器未启动或端口被占用
**解决**:
1. 检查服务器是否正在运行
2. 检查端口5000是否被其他程序占用
3. 确保防火墙允许端口5000的连接

### 错误2: "404 Not Found"
**原因**: API端点不存在
**解决**:
1. 确保使用正确的API路径 (`/api/register`, `/api/login`)
2. 检查服务器是否正确实现了所有端点

### 错误3: "500 Internal Server Error"
**原因**: 服务器内部错误
**解决**:
1. 检查服务器控制台的错误日志
2. 确保 `users.json` 文件权限正确
3. 检查请求数据格式是否正确

### 错误4: "400 Bad Request"
**原因**: 请求数据格式错误或缺少必填字段
**解决**:
1. 确保请求包含所有必填字段（username, email, password）
2. 检查JSON格式是否正确
3. 验证邮箱格式是否有效

## 📊 数据存储

服务器会在项目根目录创建 `users.json` 文件来存储用户数据：

```json
[
  {
    "user_id": "1725886204123abc456",
    "username": "testuser",
    "email": "test@example.com",
    "phone": "1234567890",
    "gender": "male",
    "distance": 0,
    "created_at": "2025-09-09T12:50:04.123Z"
  }
]
```

## ✅ 成功标志

当一切正常工作时，你应该能够：

1. **Android应用**:
   - 点击"Sign Up"按钮成功注册用户
   - 点击"🔧 Test Server Connection"看到绿色成功消息
   - 注册成功后自动跳转到登录页面

2. **服务器端**:
   - 在控制台看到详细的请求日志
   - `users.json` 文件中出现新注册的用户数据
   - 所有API测试返回正确的JSON响应

## 🚀 下一步

一旦服务器正常运行：
1. 测试Android应用的完整注册流程
2. 测试登录功能
3. 验证数据持久化（重启服务器后数据仍存在）
4. 可以开始开发其他功能（用户资料、设置等）

如果仍有问题，请提供具体的错误消息，我会进一步帮助你解决！ 